#!/bin/bash

set -o errexit

MODEL_NAME=${1:-default}
MODEL_DIR="./EXparser/Dataset/${MODEL_NAME}"

if ! [[ -d "${MODEL_DIR}" ]]; then
  echo "Model $MODEL_NAME does not exist"
  exit 1
fi

TEST_LYT_DIR="${MODEL_DIR}/TEST_LYT"
TEST_SEG_DIR="${MODEL_DIR}/TEST_SEG"
EXPARSER_LYT_INPUT_DIR=./Data/2-layouts
EXPARSER_SEG_INPUT_DIR=./Data/3-refs
EXPARSER_SEG_OUTPUT_DIR=./Data/3-refs_seg
DEF_SEG_DIR="./EXparser/Dataset/default/SEG"


if ! [[ -d "$TEST_LYT_DIR" ]] || ! [[ -d "${TEST_SEG_DIR}" ]] ; then
  echo "Model $MODEL_NAME is missing the TEST_LYT and/or TEST_SEG folders"
  exit 1
fi

echo
echo "=========================================================================================="
echo "Running Exparser, please wait..."
echo "=========================================================================================="
echo

# clean subfolders and copy layout evaluation data
find ./Data/ -type f -not -name '.*' -exec rm {} +
cp $TEST_LYT_DIR/* $EXPARSER_LYT_INPUT_DIR

# run exparser to produce extracted references
docker run -it --rm -v $(pwd):/app excite_toolchain exparser $MODEL_NAME

echo
echo "=========================================================================================="
echo "Running segmentation on correctly extracted lines, please wait..."
echo "=========================================================================================="
echo

docker run -it --rm -v $(pwd):/app excite_toolchain segmentation $MODEL_NAME $TEST_SEG_DIR

echo
echo "=========================================================================================="
echo "Evaluating extraction, please wait..."
echo "=========================================================================================="
echo

#  gold: SEG files without tags, input: exparser extraction output
docker run -it --rm -v $(pwd):/app excite_toolchain eval $TEST_SEG_DIR $EXPARSER_SEG_INPUT_DIR extr $MODEL_DIR

echo
echo "=========================================================================================="
echo "Evaluating segmentation, please wait..."
echo "=========================================================================================="
echo

# gold: original SEG files, input: output of exparser segmentation
docker run -it --rm -v $(pwd):/app excite_toolchain eval $DEF_SEG_DIR $EXPARSER_SEG_OUTPUT_DIR seg $MODEL_DIR

echo "Logfiles and CSV data have been written to ./Exparser/Dataset/${MODEL_NAME}"
