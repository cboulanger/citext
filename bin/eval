#!/bin/bash

MODEL_NAME=${1:-default}
MODEL_DIR="./EXparser/Dataset/${MODEL_NAME}"

if ! [[ -d "${MODEL_DIR}" ]]; then
  echo "Model $MODEL_NAME does not exist"
  exit 1
fi

LRT_DIR="${MODEL_DIR}/LRT"
LYT_DIR="${MODEL_DIR}/LYT"

# clean subfolders
find ./Data/ -type f -not -name '.*' -exec rm {} +

if ! [[ -d "$LRT_DIR" ]] || ! [[ -d "${MODEL_DIR}/SEG" ]] ; then
  echo "Model $MODEL_NAME has no LRT and/or SEG gold standard data"
  exit 1
fi

if ! [[ -d "$LYT_DIR" ]]; then
  mkdir -p "$LYT_DIR"
fi

# re-create LYT file if it does not exist
for LRT_FILE in $LRT_DIR/* ; do
  LYT_FILE="$LYT_DIR/$(basename $LRT_FILE)"
  if ! [[ -f "$LYT_FILE" ]] ; then
    sed -E 's/<\/?(ref|oth)>//g' $LRT_FILE > $LYT_FILE
  fi
done

# select 20% of layout files for evaluation
NUM_FILES=$(($(ls $LRT_DIR | wc -l) / 20))
NUM_FILES=$(($NUM_FILES < 5 ? 5 : $NUM_FILES))
EVAL_FILES=$(ls $LRT_DIR | shuf -n $NUM_FILES)
echo "Using $NUM_FILES files from $LRT_DIR for evaluation."
for file in $EVAL_FILES ; do
    cp "${LYT_DIR}/$file" ./Data/2-layouts
done

echo
echo "=========================================================================================="
echo "Running Exparser, please wait..."
echo "=========================================================================================="
echo

docker run -v $(pwd):/app excite_toolchain exparser $MODEL_NAME

echo
echo "=========================================================================================="
echo "Evaluating extraction, please wait..."
echo "=========================================================================================="
echo

docker run -it --rm -v $(pwd):/app excite_toolchain eval ./Exparser/Dataset/${MODEL_NAME}/SEG/ ./Data/3-refs/ extr ./Exparser/Dataset/${MODEL_NAME}

echo
echo "=========================================================================================="
echo "Creating input for segmentation without tags..."
echo "=========================================================================================="
echo
if [ ! -d "./Exparser/Dataset/${MODEL_NAME}/CLEAN_SEG/" ];
then
  mkdir -p "./Exparser/Dataset/${MODEL_NAME}/CLEAN_SEG/";
  for filename in ./Exparser/Dataset/${MODEL_NAME}/SEG/*; do
    out_name=$(basename $filename)
    sed 's/<[^>]*>//g' $filename | sed '/^$/d' > "./Exparser/Dataset/${MODEL_NAME}/CLEAN_SEG/${out_name}"
  done
fi

echo
echo "=========================================================================================="
echo "Running segmentation on correctly extracted lines, please wait..."
echo "=========================================================================================="
echo

docker run -v $(pwd):/app excite_toolchain segmentation $MODEL_NAME ./Exparser/Dataset/${MODEL_NAME}/CLEAN_SEG/

echo
echo "=========================================================================================="
echo "Evaluating segmentation, please wait..."
echo "=========================================================================================="
echo

docker run -it --rm -v $(pwd):/app excite_toolchain eval ./Exparser/Dataset/${MODEL_NAME}/SEG/ ./Data/3-refs_seg/ seg ./Exparser/Dataset/${MODEL_NAME}
echo "Logfiles and CSV data have been written to ./Exparser/Dataset/${MODEL_NAME}"
